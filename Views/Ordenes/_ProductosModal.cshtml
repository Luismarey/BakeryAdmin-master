@model BakeryAdmin.Models.OrdenItem

<div class="modal fade" id="productosModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">Administrar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="productoForm" method="post" class="needs-validation" novalidate>
                    <!-- Campos ocultos -->
                    <input asp-for="OrdenItemId" type="hidden" />
                    <input asp-for="OrdenId" type="hidden" />

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select asp-for="ProductoId" class="form-select" asp-items="ViewBag.Productos" required>
                                    <option value="">-- Selecciona un Producto --</option>
                                </select>
                                <label asp-for="ProductoId">Producto</label>
                                <span asp-validation-for="ProductoId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input asp-for="Cantidad" type="number" class="form-control" placeholder="Cantidad" required />
                                <label asp-for="Cantidad">Cantidad</label>
                                <span asp-validation-for="Cantidad" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input asp-for="PrecioUnitario" type="number" step="0.01" class="form-control" placeholder="Precio Unitario" required />
                                <label asp-for="PrecioUnitario">Precio Unitario</label>
                                <span asp-validation-for="PrecioUnitario" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input asp-for="Descuento" type="number" step="0.01" class="form-control" placeholder="Descuento" />
                                <label asp-for="Descuento">Descuento</label>
                                <span asp-validation-for="Descuento" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input asp-for="Subtotal" type="number" step="0.01" class="form-control" placeholder="Sub total" readonly />
                                <label asp-for="Subtotal">Sub total</label>
                                <span asp-validation-for="Subtotal" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="submit" id="btnGuardarProducto" class="btn btn-primary">
                            <i class="fa fa-save"></i> Guardar
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fa fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        'use strict';

        // Validación de formularios Bootstrap
        const forms = document.querySelectorAll('.needs-validation');
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });

        // Cálculo automático del subtotal
        const productoForm = document.getElementById('productoForm');
        if (productoForm) {
            const cantidad = productoForm.querySelector('[name="Cantidad"]');
            const precioUnitario = productoForm.querySelector('[name="PrecioUnitario"]');
            const descuento = productoForm.querySelector('[name="Descuento"]');
            const subtotal = productoForm.querySelector('[name="Subtotal"]');
            const productoSelect = productoForm.querySelector('[name="ProductoId"]');

            function calcularSubtotal() {
                const cant = parseFloat(cantidad?.value) || 0;
                const precio = parseFloat(precioUnitario?.value) || 0;
                const desc = parseFloat(descuento?.value) || 0;

                const subtotalCalculado = (cant * precio) - desc;
                if (subtotal) {
                    subtotal.value = subtotalCalculado.toFixed(2);
                }
            }

            // Si el <option> trae data-price, asignarlo automáticamente al cambiar producto.
            productoSelect?.addEventListener('change', function () {
                const opt = productoSelect.options[productoSelect.selectedIndex];
                if (opt && opt.dataset && opt.dataset.price) {
                    precioUnitario.value = parseFloat(opt.dataset.price).toFixed(2);
                }
                calcularSubtotal();
            });

            // Calcular subtotal cuando cambien los valores
            cantidad?.addEventListener('input', calcularSubtotal);
            precioUnitario?.addEventListener('input', calcularSubtotal);
            descuento?.addEventListener('input', calcularSubtotal);

            // Calcular al abrir modal si hay valores
            calcularSubtotal();
        }
    })();
</script>