@model BakeryAdmin.Models.PersonaBase
@using Microsoft.AspNetCore.Mvc.Rendering
@using static BakeryAdmin.Models.Enums

@{
    ViewData["Title"] = "Editar Persona";
}

<h2 class="mb-4">Editar Persona</h2>

<form asp-action="Edit" method="post" class="needs-validation" novalidate>
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="PersonaId" />
    <input type="hidden" asp-for="PasswordHash" /> 
    <input type="hidden" asp-for="Username" />
    
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <div class="form-floating">
                <input asp-for="Nombres" class="form-control" maxlength="40" placeholder="Nombres" required />
                <label asp-for="Nombres">Nombre</label>
                <span asp-validation-for="Nombres" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-floating">
                <input asp-for="Apellidos" class="form-control" maxlength="40" placeholder="Apellidos" required />
                <label asp-for="Apellidos">Apellido</label>
                <span asp-validation-for="Apellidos" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <div class="form-floating">
                <select asp-for="TipoPersona" class="form-control" disabled asp-items="@(Html.GetEnumSelectList<TipoPersona>())"> 
                </select>
                <input type="hidden" asp-for="TipoPersona" /> 
                <label asp-for="TipoPersona">Tipo de Persona</label>
                <span asp-validation-for="TipoPersona" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-floating">
                <input asp-for="NumCi" class="form-control" maxlength="15" placeholder="Carnet de Identidad" />
                <label asp-for="NumCi">C.I. (Opcional)</label>
                <span asp-validation-for="NumCi" class="text-danger"></span>
            </div>
        </div>
    </div>
    
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <div class="form-floating">
                <input asp-for="Correo_Electronico" class="form-control" placeholder="Correo_Electronico" />
                <label asp-for="Correo_Electronico">Email</label>
                <span asp-validation-for="Correo_Electronico" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-floating">
                <input asp-for="NumCelular" class="form-control" maxlength="15" placeholder="NumCelular" required />
                <label asp-for="NumCelular">Móvil</label>
                <span asp-validation-for="NumCelular" class="text-danger"></span>
            </div>
        </div>
    </div>


    @if (Model is Empleado empleado) // <--- PATTERN MATCHING
    {
        <h4 class="mt-4">Datos de Empleado</h4>

        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="form-floating">
                    <input name="Profesion" id="Profesion" class="form-control" maxlength="40" placeholder="Profesión" value="@(empleado?.Profesion ?? "")" />
                    <label for="Profesion">Profesión</label>
                    <span class="text-danger">@Html.ValidationMessage("Profesion", null, new { @class = "text-danger" })</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-floating">
                    <input name="Numero_Licencia" id="Numero_Licencia" class="form-control" maxlength="15" placeholder="Número de Licencia" value="@(empleado?.Numero_Licencia ?? "")" />
                    <label for="Numero_Licencia">N° Licencia</label>
                    <span class="text-danger">@Html.ValidationMessage("Numero_Licencia", null, new { @class = "text-danger" })</span>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="form-floating">
                    <input name="Categoria_Licencia" id="Categoria_Licencia" class="form-control" maxlength="2" placeholder="Categoría de Licencia" value="@(empleado?.Categoria_Licencia ?? "")" />
                    <label for="Categoria_Licencia">Cat. Licencia</label>
                    <span class="text-danger">@Html.ValidationMessage("Categoria_Licencia", null, new { @class = "text-danger" })</span>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="form-floating">
                    <input name="Turno" id="Turno" class="form-control" maxlength="10" placeholder="Turno" value="@(empleado?.Turno ?? "")" />
                    <label for="Turno">Turno</label>
                    <span class="text-danger">@Html.ValidationMessage("Turno", null, new { @class = "text-danger" })</span>
                </div>
            </div>
            
            <div class="col-md-4 d-flex align-items-center">
                <div class="form-check">
                    <input type="hidden" name="Mobilidad" value="false" />
                    <input name="Mobilidad" id="Mobilidad" class="form-check-input" type="checkbox" value="true" @(empleado?.Mobilidad == true ? "checked" : "") />
                    <label class="form-check-label" for="Mobilidad">
                        Con Movilidad Propia
                    </label>
                    <span class="text-danger">@Html.ValidationMessage("Mobilidad", null, new { @class = "text-danger" })</span>
                </div>
            </div>
        </div>

    }
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <div class="form-floating">
                <input asp-for="Fecha_Nacimiento" class="form-control" type="date" placeholder="Fecha_Nacimiento" />
                <label asp-for="Fecha_Nacimiento">Fecha de Nacimiento</label>
                <span asp-validation-for="Fecha_Nacimiento" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-6 d-flex align-items-end justify-content-end">
            <button class="btn btn-success btn-lg" type="submit"><i class="fa-solid fa-save"></i> Guardar Cambios</button>
        </div>
    </div>
</form>

<a asp-action="Index" class="btn btn-secondary mt-3"><i class="fa fa-times"></i> Cancelar</a>

<div>
    @await Html.PartialAsync("_DireccionesModal", new BakeryAdmin.Models.Direccion { PersonaId = Model.PersonaId }) 
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(function () {
            // Inicializar datepicker
            $('#Fecha_Nacimiento').datepicker({ // Asumiendo que el campo es Fecha_Nacimiento
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true
            });
        });
    </script>
    <script>
        $(document).ready(function() {
            // ... (Lógica de submit con Swal.fire, la dejamos igual) ...
            $('form.needs-validation').off('submit').on('submit', function(e) {

                e.preventDefault();

                var form = this;
                if (!form.checkValidity()) {
                    $(form).addClass('was-validated');
                    return;
                }

                Swal.fire({
                    title: '¿Deseas guardar este registro?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, guardar',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $(form).off('submit');
                        form.submit();
                    }
                });
            });
        });
    </script>
}
